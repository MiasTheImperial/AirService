# AirService

Полноценное фулл-стек приложение для заказа услуг во время полёта. Репозиторий содержит REST API на Flask и клиентское приложение на React&nbsp;Native (Expo).

## Возможности

* каталог товаров и услуг с фильтрами и иерархией категорий;
* оформление заказов пассажирами и панель администратора для управления ими;
* очереди задач и интеграция с внешними сервисами через Redis/RQ;
* отправка push-уведомлений о статусе заказа через SSE;
* журналирование запросов в формате JSON;
* локализация на русский и английский языки;
* выбранный язык сохраняется и его можно изменить в профиле через меню выбора языка;
* при английском интерфейсе цены автоматически переводятся в доллары по курсу 1 $ ≈ 80 ₽;
* адаптивный фронтенд, работающий как на мобильных устройствах, так и в браузере.

## Быстрый старт

```bash
# 1. Зависимости Python
pip install -r requirements.txt

# 2. Строка подключения к БД (по умолчанию SQLite)
export DATABASE_URL=postgresql://user:password@localhost/airservice  # при необходимости

# 3. Применяем миграции и загружаем демо-данные
export FLASK_APP=run.py
flask db upgrade
flask seed-data

# 4. Запуск сервера
FLASK_APP=run.py flask run --host=0.0.0.0  # переменные SSL_CERT/SSL_KEY включат HTTPS при наличии

# 5. Воркер очереди (для интеграций и уведомлений)
python run_worker.py  # REDIS_URL задаёт адрес Redis
```

### Настройка фронтенда

```bash
# установка зависимостей и сборка web-версии
cd frontend
npm install --legacy-peer-deps
npm run web-build
EXPO_PUBLIC_API_URL=http://192.168.x.x:5000 npm run web-build
# 192.168.178.20

# в режиме разработки
# локальный сервер
EXPO_PUBLIC_API_URL=http://localhost:5000 npm start
# или для доступа с других устройств в локальной сети
EXPO_PUBLIC_API_URL=http://192.168.x.x:5000 npm start
```

При сборке переменная `EXPO_PUBLIC_API_URL` обязательна, иначе URL бэкенда остаётся `http://localhost:5000`.

По умолчанию статические файлы из `frontend/web-build` раздаются Flask-приложением. Для мобильных платформ Expo предоставляет эмуляторы и возможность публикации.

## Конфигурация

Основные переменные окружения:

| Переменная           | Значение по умолчанию        | Назначение                                        |
|----------------------|------------------------------|---------------------------------------------------|
| `DATABASE_URL`       | `sqlite:///airservice.db`    | строка подключения к БД                           |
| `ADMIN_USERNAME`     | `admin`                      | логин администратора                              |
| `ADMIN_PASSWORD`     | `admin`                      | пароль администратора (или `ADMIN_PASSWORD_HASH`) |
| `API_RATE_LIMIT`     | `100 per hour`               | лимит запросов на IP                              |
| `FRONTEND_ORIGIN`    | `*`                          | разрешённый Origin для CORS                       |
| `REDIS_URL`          | `redis://localhost:6379/0`   | адрес Redis для очередей                          |
| `EXPO_PUBLIC_API_URL`| `http://localhost:5000`      | URL бэкенда для фронтенда                         |

При изменении переводов выполните `pybabel compile -d airservice/translations`.

## Работа приложения

API предоставляет эндпоинты `/catalog`, `/orders`, `/auth`, `/admin/*` и `/integration/*`. Административные запросы требуют basic‑аутентификации. События об изменении заказов транслируются через SSE на `/notifications`. Данные хранятся в SQLite или PostgreSQL. Очередь Redis используется для отложенных задач отправки сообщений во внешние системы.

Логи сервера пишутся в `airservice.log` с полями `timestamp`, `user`, `endpoint`, `message`.

## Тестирование

```bash
pytest -q
```

Набор тестов охватывает весь REST API, проверки локализации, администраторские операции, SSE‑уведомления и вспомогательные сервисы. Перед запуском тестов автоматически компилируются файлы переводов.

## Генерация блок-схем

Для визуализации основных алгоритмов можно использовать скрипт `scripts/generate_flowcharts.py`. Он создаёт картинки в формате PNG с использованием `graphviz`.

```bash
pip install graphviz
python scripts/generate_flowcharts.py
```

После выполнения появятся изображения `order_flowchart.png`, `sse_flowchart.png`,
`catalog_flowchart.png`, `integration_flowchart.png` и
`admin_update_flowchart.png`.

## Лицензия

Проект распространяется под лицензией MIT.
